# from your imports
import asyncio
from fastapi import APIRouter, Depends, WebSocket, WebSocketDisconnect
from sqlalchemy.orm import Session
from .. import models, schemas, db, realtime

router = APIRouter(prefix="/comments", tags=["Comments"])

# Create comment
@router.post("/", response_model=schemas.CommentOut)
# Make the function async
async def create_comment(comment: schemas.CommentCreate, session: Session = Depends(db.SessionLocal)):
    new_comment = models.Comment(**comment.dict())
    session.add(new_comment)
    session.commit()
    session.refresh(new_comment)
    # The broadcast call will now work correctly
    await realtime.comment_manager.broadcast({
        "type": "comment",
        "username": new_comment.username,
        "message": new_comment.message,
        "created_at": str(new_comment.created_at),
    })
    return new_comment

# WebSocket for live comments
@router.websocket("/ws")
async def websocket_endpoint(websocket: WebSocket):
    await realtime.comment_manager.connect(websocket)
    try:
        while True:
            await websocket.receive_text()  # Keep connection alive
    except WebSocketDisconnect:
        realtime.comment_manager.disconnect(websocket)
